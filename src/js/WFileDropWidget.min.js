WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",function(j,b,n){jQuery.data(b,"lobj",this);var e=this,l="Wt-filedropzone-hover",c=[],m=false,i=true,g=document.createElement("input");g.type="file";g.setAttribute("multiple","multiple");$(g).hide();b.appendChild(g);this.eventContainsFile=function(a){var d=a.dataTransfer.types!=null&&a.dataTransfer.types.length>0&&a.dataTransfer.types[0]=="Files";return a.dataTransfer.items!=null&&a.dataTransfer.items.length>0&&a.dataTransfer.items[0].kind==
"file"||d};this.validFileCheck=function(a,d,h){var f=new FileReader;f.onload=function(){d(true,h)};f.onerror=function(){d(false,h)};f.readAsText(a.slice(0,32))};b.setAcceptDrops=function(a){i=a};b.ondragenter=function(a){i&&e.eventContainsFile(a)&&e.setHoverStyle(true)};b.ondragleave=function(){i&&e.setHoverStyle(false)};b.ondragover=function(a){a.preventDefault()};b.ondrop=function(a){a.preventDefault();if(i){e.setHoverStyle(false);window.FormData===undefined||a.dataTransfer.files==null||a.dataTransfer.files.length==
0||e.addFiles(a.dataTransfer.files)}};this.addFiles=function(a){for(var d=[],h=0;h<a.length;h++){var f=new XMLHttpRequest;f.id=Math.floor(Math.random()*Math.pow(2,31));f.file=a[h];c.push(f);var k={};k.id=f.id;k.filename=f.file.name;k.type=f.file.type;k.size=f.file.size;d.push(k)}j.emit(b,"dropsignal",JSON.stringify(d))};b.addEventListener("click",function(){if(i){$(g).val("");g.click()}});b.markForSending=function(a){for(var d=0;d<a.length;d++)for(var h=a[d].id,f=0;f<c.length;f++)if(c[f].id==h){c[f].ready=
true;break}m||c[0].ready&&e.requestSend()};this.requestSend=function(){if(c[0].skip)e.uploadFinished(null);else{m=true;j.emit(b,"requestsend",c[0].id)}};b.send=function(a){console.log("sending file");xhr=c[0];if(xhr.file.size>n){j.emit(b,"filetoolarge",xhr.file.size);e.uploadFinished(null)}else e.validFileCheck(xhr.file,e.actualSend,a)};this.actualSend=function(a,d){if(a){xhr=c[0];xhr.addEventListener("load",e.uploadFinished);xhr.addEventListener("error",e.uploadFinished);xhr.addEventListener("abort",
e.uploadFinished);xhr.addEventListener("timeout",e.uploadFinished);xhr.open("POST",d);a=new FormData;a.append("file-id",xhr.id);a.append("data",xhr.file);xhr.send(a)}else e.uploadFinished(null)};this.uploadFinished=function(a){console.log("finished sending (type = "+a+")");a!=null&&a.type=="load"&&a.currentTarget.status==200&&j.emit(b,"uploadfinished",c[0].id);c.splice(0,1);if(c[0]&&c[0].ready)e.requestSend();else{m=false;j.emit(b,"donesending")}};b.cancelUpload=function(a){if(c[0].id==a)c[0].abort();
else for(var d=1;d<c.length;d++)if(c[d].id==a)c[d].skip=true};g.onchange=function(){if(i)window.FormData===undefined||this.files==null||this.files.length==0||e.addFiles(this.files)};this.setHoverStyle=function(a){a?$(b).addClass(l):$(b).removeClass(l)};b.configureHoverClass=function(a){l=a};b.setFilters=function(a){g.setAttribute("accept",a)}});
