WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",function(n,c,l,m){jQuery.data(c,"lobj",this);var e=this,j="Wt-filedropzone-hover",b=[],k=false,i=true;this.eventContainsFile=function(a){var d=a.dataTransfer.types!=null&&a.dataTransfer.types.length>0&&a.dataTransfer.types[0]=="Files";return a.dataTransfer.items!=null&&a.dataTransfer.items.length>0&&a.dataTransfer.items[0].kind=="file"||d};this.validFileCheck=function(a,d){var g=new FileReader;g.onload=function(){d(true)};g.onerror=function(){d(false)};
g.readAsText(a)};c.setAcceptDrops=function(a){i=a};c.ondragenter=function(a){i&&e.eventContainsFile(a)&&e.setHoverStyle(true)};c.ondragleave=function(){i&&e.setHoverStyle(false)};c.ondragover=function(a){a.preventDefault()};c.ondrop=function(a){a.preventDefault();if(i){e.setHoverStyle(false);if(!(window.FormData===undefined||a.dataTransfer.files==null||a.dataTransfer.files.length==0)){Math.floor(Math.random()*32768);for(var d=[],g=0;g<a.dataTransfer.files.length;g++){var f=new XMLHttpRequest;f.id=
Math.floor(Math.random()*Math.pow(2,31));f.file=a.dataTransfer.files[g];b.push(f);var h={};h.id=f.id;h.filename=f.file.name;h.type=f.file.type;h.size=f.file.size;d.push(h)}console.log(d);Wt.emit(c,"dropsignal",JSON.stringify(d))}}};c.markForSending=function(a){for(var d=0;d<a.length;d++)for(var g=a[d].id,f=0;f<b.length;f++)if(b[f].id==g){b[f].ready=true;break}k||b[0].ready&&e.requestSend()};this.requestSend=function(){if(b[0].skip)e.uploadFinished(null);else{k=true;Wt.emit(c,"requestsend",b[0].id)}};
c.send=function(){console.log("sending file");xhr=b[0];if(xhr.file.size>m){Wt.emit(c,"filetoolarge",xhr.file.size);e.uploadFinished(null)}else e.validFileCheck(xhr.file,e.actualSend)};this.actualSend=function(a){if(a){xhr=b[0];xhr.addEventListener("load",e.uploadFinished);xhr.addEventListener("error",e.uploadFinished);xhr.addEventListener("abort",e.uploadFinished);xhr.addEventListener("timeout",e.uploadFinished);xhr.open("POST",l);a=new FormData;a.append("file-id",xhr.id);a.append("data",xhr.file);
xhr.send(a)}else e.uploadFinished(null)};this.uploadFinished=function(a){console.log("finished sending (type = "+a+")");a!=null&&a.type=="load"&&a.currentTarget.status==200&&Wt.emit(c,"uploadfinished",b[0].id);b.splice(0,1);if(b[0]&&b[0].ready)e.requestSend();else{k=false;Wt.emit(c,"donesending")}};c.cancelUpload=function(a){if(b[0].id==a)b[0].abort();else for(var d=1;d<b.length;d++)if(b[d].id==a)b[d].skip=true};this.setHoverStyle=function(a){a?$(c).addClass(j):$(c).removeClass(j)};c.configureHoverClass=
function(a){j=a}});
